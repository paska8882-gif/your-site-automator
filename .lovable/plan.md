
# План оптимізації функції редагування сайтів

## Проблема

Функція редагування сайтів (`edit-website`) працює вкрай повільно (до 30 хвилин) та часто видає помилки. 

### Виявлені причини:

1. **Величезний контекст** - передається 21 файл (~276KB тексту) при КОЖНОМУ запиті на редагування
2. **Відсутній timeout** - функція не має `max_duration_seconds` в `config.toml`
3. **Немає AbortController** - AI запит може "висіти" нескінченно без переривання
4. **Неефективний промпт** - AI має повернути ВСІ файли, навіть якщо змінити треба лише 1
5. **Немає fallback моделей** - якщо одна модель не справляється, інші не пробуються

## Рішення

### 1. Оптимізація промпту - передавати тільки релевантні файли

Замість передачі всіх 21 файлів, передавати тільки ті, які потрібні для редагування:
- AI спершу аналізує запит користувача
- Визначає які файли потрібні (index.html, styles.css тощо)
- Передається тільки 3-5 релевантних файлів
- Результат: ~90% зменшення контексту

### 2. Додати timeout та AbortController

```text
[functions.edit-website]
verify_jwt = false
max_duration_seconds = 180   # 3 хвилини максимум
```

В коді:
- AbortController з 120-секундним таймаутом на AI запит
- Graceful handling при timeout

### 3. Додати fallback моделі

Якщо основна модель (gemini-2.5-flash) не справляється:
1. Спробувати gemini-2.5-flash-lite (швидша)
2. Якщо Senior - fallback на gpt-4o-mini

### 4. Розумний парсинг відповіді

Замість вимагати ВСІ файли назад:
- AI повертає тільки ЗМІНЕНІ файли
- Frontend автоматично мержить з оригіналами
- Зменшує розмір відповіді в 5-10 разів

### 5. Прогрес та UX

- Показувати прогрес в чаті ("Аналізую запит...", "Редагую файли...")
- Якщо довше 30 секунд - показувати попередження
- Можливість скасувати запит

## Технічні зміни

### Файл: `supabase/config.toml`
- Додати `max_duration_seconds = 180` для edit-website

### Файл: `supabase/functions/edit-website/index.ts`
1. Додати AbortController з 120s timeout
2. Змінити промпт: AI повертає ТІЛЬКИ змінені файли
3. Додати fallback моделі (gemini-flash-lite, gpt-4o-mini)
4. Оптимізувати парсинг файлів
5. Кращий error handling з конкретними повідомленнями

### Файл: `src/components/EditChat.tsx`
1. Показувати прогрес редагування
2. Додати кнопку скасування
3. Таймаут на клієнті (150s) з graceful handling
4. Мердж результату з оригінальними файлами

## Очікуваний результат

| Метрика | Було | Стане |
|---------|------|-------|
| Середній час редагування | 30+ хвилин | 15-60 секунд |
| Розмір контексту | ~276KB | ~30KB |
| Успішність запитів | ~50% | ~95% |
| Timeout помилки | Часто | Рідко (з fallback) |

## Порядок імплементації

1. Оновити `config.toml` - додати timeout
2. Переписати `edit-website` Edge Function з AbortController та fallback
3. Оновити промпт для часткового повернення файлів
4. Оновити `EditChat.tsx` для прогресу та мерджу файлів
